import "dotenv/config";
import crypto from "crypto";
import axios from "axios";

const PARTNER_ID = process.env.PARTNER_ID;
const SECRET_KEY = process.env.SECRET_KEY;

if (!PARTNER_ID || !SECRET_KEY) {
  console.error("âŒ ERROR: PARTNER_ID o SECRET_KEY no estÃ¡n definidos en .env");
  process.exit(1);
}

async function listProducts() {
  console.log("\n===============================");
  console.log("ğŸ“¡ Enviando solicitud a MooGold...");
  console.log("===============================\n");

  const path = "product/list_product";

  // Puedes ajustar el payload dependiendo del endpoint
  const payload = {
   
    "path": "product/list_product",
    "category_id": 874
  };

  const payloadJson = JSON.stringify(payload);
  const timestamp = Math.floor(Date.now() / 1000).toString();

  // Crear firma
  const stringToSign = payloadJson + timestamp + path;
  const auth = crypto
    .createHmac("sha256", SECRET_KEY as string)
    .update(stringToSign)
    .digest("hex");

  const authBasic = Buffer.from(`${PARTNER_ID}:${SECRET_KEY}`).toString("base64");

  try {
    const response = await axios.post(
      "https://moogold.com/wp-json/v1/api/product/list_product",
      payload,
      {
        headers: {
          "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:132.0) Gecko/20100101 Firefox/132.0",
          "timestamp": timestamp,
          "auth": auth,
          "Authorization": `Basic ${authBasic}`,
          "Content-Type": "application/json",
          "Accept": "application/json",
        },
        validateStatus: () => true, // permitir capturar 403, 404, etc.
      }
    );

    console.log("ğŸ“¥ Respuesta:");
    console.log(response.status, response.data);

  } catch (error: any) {
    console.error("\nâŒ ERROR DE AXIOS:");
    console.error(error.message);
  }
}

listProducts();

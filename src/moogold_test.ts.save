import axios from "axios";
import CryptoJS from "crypto-js";
import dotenv from "dotenv";
import * as https from "https";
import * as http from "http";

dotenv.config();

const ipv4Agents = {
  httpAgent: new http.Agent({ family: 4 }),
  httpsAgent: new https.Agent({ family: 4 }),
};

async function testProducts() {
  const partnerId = process.env.PARTNER_ID!;
  const secretKey = process.env.SECRET_KEY!;

  const endpoint = "https://moogold.com/wp-json/v1/api/product/list_product";

  const payload = {
    path: "product/list_product",
    category_id: 50,
  };

  const timestamp = Math.floor(Date.now() / 1000);

  const stringToSign = JSON.stringify(payload) + timestamp + "product/list_product";

  const authSignature = CryptoJS.HmacSHA256(stringToSign, secretKey).toString();

  const basicAuth = Buffer.from(`${partnerId}:${secretKey}`).toString("base64");

  try {
    console.log("üîç Enviando request forzado por IPv4...");

    const response = await axios.post(endpoint, payload, {
      ...ipv4Agents,
      headers: {
        "Content-Type": "application/json",
        Authorization: `Basic ${basicAuth}`,
        timestamp: timestamp.toString(),
        auth: authSignature,
      },
    });

    console.log("SUCCESS:", response.data);
  } catch (err: any) {
    console.log("ERROR RESPONSE:");
    console.log(err.response?.status, err.response?.data || err.message);
  }
}

testProducts();
